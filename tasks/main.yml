- name: get stat of /var/web
  stat:
    path: /var/web
  register: dir

- name: remove /var/web if its still a link (default in dork.nginx)
  file:
    path: /var/web
    state: absent
  when: dir.stat.islnk is defined and dir.stat.islnk

- name: create docroot as real directory
  file:
    path: /var/web
    state: directory

- include: cli.yml
  tags: drupal_cli

- include: mariadb.yml
  tags: drupal_mariadb

- include: profile.yml
  tags: drupal_profile

- include: root.yml
  tags: drupal_root

- include: composer.yml
  tags: drupal_composer

- name: create local drush directory
  file:
    path: /root/.drush
    mode: 0755
    state: directory
  tags: drupal_cli

- name: generate drushrc.php
  template:
    src: drushrc.php.j2
    dest: /root/.drush/drushrc.php
  tags: drupal_cli

- name: run drush as root to download dependencies
  shell: drush status
  when: drush.changed
  tags: drupal_cli

- name: override nginx vhost
  template:
    src: dork.conf.j2
    dest: /etc/nginx/conf.d/dork.conf

- name: remove existing installation
  file:
    path: "{{ item }}"
    state: absent
  with_items:
  - /var/web{{ drupal_docroot }}/sites/default/settings.php
  - /var/web{{ drupal_docroot }}/sites/default/files
  tags: drupal_install

- name: make sites directory writable
  file:
    path: /var/web/sites/default
    mode: 0755
    state: directory
  tags: drupal_install

- name: Set config_installer as installation profile.
  set_fact:
    drupal_install_profile: 'config_installer'
  tags: drupal_config_install

- set_fact:
    drupal_install_profile: "{{ drupal_profile }}"
  when: not drupal_install_profile
  tags: drupal_install

- set_fact:
    drupal_install_parameters:
      config_installer_sync_configure_form.sync_directory: '../config'
  tags: drupal_config_install

- set_fact:
    drupal_install_params: ''
  tags: drupal_install

- set_fact:
    drupal_install_params: >
      {{ drupal_install_params }} {{ item.key }}="{{ item.value }}"
  with_dict: "{{ drupal_install_parameters }}"
  tags: drupal_install

- name: install drupal
  shell: >
    drush si
    --account-name={{ drupal_user }}
    --account-pass={{ drupal_pass }}
    --db-url=mysql://root@localhost/drupal
    {{ drupal_install_profile }} -y
    {{ drupal_install_params }}
  args:
    chdir: /var/web{{ drupal_docroot }}/sites/default
  tags: drupal_install

- name: update drupal
  shell: drush updb -y
  tags: drupal_update

- name: revert features
  shell: drush fra -y
  ignore_errors: yes
  tags: drupal_features

- name: import configuration
  shell: drush cim --partial -y
  ignore_errors: yes
  tags: drupal_config_import

- name: cache clear
  shell: drush {{ drupal_cache_command }}
  tags: drupal_cache

- name: sync build
  shell: >
    rsync -ru --delete
    --exclude=sites/default
    --include=sites/default/default.settings.php
    /var/web/ /var/build/
  tags: always

- include: syslog.yml
  when: drupal_syslog
